# 5.3 Bootable Media Creation

This section covers building the autoinstall ISO using xorriso in-place modification.

**Important:** Do NOT extract and rebuild the ISO with `xorriso -as mkisofs` - this corrupts the boot structure. Use in-place modification instead.

## Build Workflow

The build process renders templates locally, then builds the ISO inside a multipass VM:

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Render templates (local)                                    │
│     make all                                                    │
│     → output/user-data, output/scripts/build-iso.sh             │
├─────────────────────────────────────────────────────────────────┤
│  2. Transfer repo to builder VM                                 │
│     multipass transfer . iso-builder:~/build/                   │
├─────────────────────────────────────────────────────────────────┤
│  3. Build ISO (inside VM)                                       │
│     cd ~/build && ./output/scripts/build-iso.sh                 │
│     → output/ubuntu-autoinstall.iso                             │
├─────────────────────────────────────────────────────────────────┤
│  4. Retrieve build artifacts                                    │
│     multipass transfer iso-builder:~/build/output ./            │
└─────────────────────────────────────────────────────────────────┘
```

## build-iso.sh.tpl

The build script is rendered from a Jinja2 template using values from `image.config.yaml` (see [5.1](./DOWNLOAD_UBUNTU_ISO.md)).

**src/scripts/build-iso.sh.tpl:**

```bash
#!/bin/bash
# build-iso.sh - Build autoinstall ISO using xorriso in-place modification
# Run inside multipass VM: ./output/scripts/build-iso.sh
# Generated from build-iso.sh.tpl - do not edit directly
set -e

# Script is in output/scripts/, go up one level to output/
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
OUTPUT_ISO="$SCRIPT_DIR/ubuntu-autoinstall.iso"

# Image settings from image.config.yaml
RELEASE="{{ image.release }}"
TYPE="{{ image.type }}"
ARCH="{{ image.arch }}"

echo "=== Installing dependencies ==="
sudo apt-get update -qq
sudo apt-get install -y -qq xorriso cloud-image-utils wget

echo "=== Querying latest Ubuntu ISO ==="
# See 5.1 Download Ubuntu Server ISO for details on ubuntu-cloudimg-query
ISO_URL=$(ubuntu-cloudimg-query "$RELEASE" "$TYPE" "$ARCH" --format "%{url}\n")
ISO_NAME=$(ubuntu-cloudimg-query "$RELEASE" "$TYPE" "$ARCH" --format "%{filename}\n")

echo "=== Downloading Ubuntu ISO (if not cached) ==="
if [ ! -f "$HOME/$ISO_NAME" ]; then
    wget -q --show-progress "$ISO_URL" -O "$HOME/$ISO_NAME"
else
    echo "Using cached ISO: $ISO_NAME"
fi

echo "=== Copying ISO for modification ==="
cp "$HOME/$ISO_NAME" "$OUTPUT_ISO"

echo "=== Creating config directories ==="
mkdir -p "$HOME/nocloud_add" "$HOME/grub_mod"

# user-data is generated by `make autoinstall` in output/
cp "$SCRIPT_DIR/user-data" "$HOME/nocloud_add/"

# meta-data is minimal
cat > "$HOME/nocloud_add/meta-data" << 'EOF'
instance-id: autoinstall-001
EOF

echo "=== Creating GRUB config ==="
cat > "$HOME/grub_mod/grub.cfg" << 'GRUBEOF'
set timeout=5
set default=0
loadfont unicode
set menu_color_normal=white/black
set menu_color_highlight=black/light-gray

menuentry "Autoinstall Ubuntu Server" {
    set gfxpayload=keep
    linux /casper/vmlinuz autoinstall ds=nocloud\;s=/cdrom/nocloud/ consoleblank=0 ---
    initrd /casper/initrd
}

menuentry "Ubuntu Server (Manual Install)" {
    set gfxpayload=keep
    linux /casper/vmlinuz ---
    initrd /casper/initrd
}
GRUBEOF

echo "=== Modifying ISO in-place with xorriso ==="
xorriso -indev "$OUTPUT_ISO" \
    -outdev "$OUTPUT_ISO" \
    -boot_image any replay \
    -map "$HOME/nocloud_add" /nocloud \
    -map "$HOME/grub_mod/grub.cfg" /boot/grub/grub.cfg \
    -commit

echo "=== Verifying ISO ==="
xorriso -indev "$OUTPUT_ISO" -ls /nocloud 2>/dev/null || true

echo "=== ISO built successfully ==="
ls -lh "$OUTPUT_ISO"
```

## Usage

### 1. Render Templates (Local)

```powershell
# Render all templates using Chapter 3 build system
make all
```

This generates:
- `output/user-data` - Autoinstall configuration
- `output/scripts/build-iso.sh` - ISO build script (from template)
- `output/scripts/early-net.sh` - Network detection script

### 2. Transfer Repo to Builder VM

```powershell
# Transfer entire repo to builder VM
multipass transfer . iso-builder:/home/ubuntu/build/
```

### 3. Build ISO (Inside VM)

```powershell
multipass exec iso-builder -- bash -c "cd ~/build && chmod +x output/scripts/build-iso.sh && ./output/scripts/build-iso.sh"
```

The rendered script uses values from `image.config.yaml` to query and download the correct Ubuntu ISO.

### 4. Retrieve Build Artifacts

```powershell
# Transfer entire output directory
multipass transfer iso-builder:/home/ubuntu/build/output ./
```

This retrieves all build artifacts:
- `output/ubuntu-autoinstall.iso` - Bootable installation media
- `output/user-data` - Autoinstall configuration
- `output/scripts/build-iso.sh` - Rendered build script
- `output/scripts/early-net.sh` - Network detection script

## Template Context

The `build-iso.sh.tpl` template has access to:

| Context | Source | Description |
|---------|--------|-------------|
| `image.*` | `image.config.yaml` | Ubuntu release, type, architecture |

## Script Details

| Step | Description |
|------|-------------|
| Install dependencies | Installs `xorriso`, `wget`, and `cloud-image-utils` |
| Query ISO | Uses `ubuntu-cloudimg-query` with values from `image.config.yaml` |
| Download ISO | Downloads Ubuntu Server ISO (cached for subsequent builds) |
| Copy ISO | Creates working copy to preserve original |
| Create nocloud directory | Copies `output/user-data` from make build, creates minimal `meta-data` |
| Create GRUB config | Sets up autoinstall boot menu entry |
| Modify ISO | Uses xorriso in-place modification (preserves boot structure) |
| Verify | Lists `/nocloud` directory contents |

## Critical GRUB Configuration Notes

The kernel command line **MUST** include the datasource parameter with escaped semicolon:
```
ds=nocloud\;s=/cdrom/nocloud/
```

Without this parameter, cloud-init won't find the user-data and autoinstall won't trigger.

The `consoleblank=0` parameter prevents screen blanking during installation.

## Verification

After creating media, verify it boots correctly:

1. Boot a test VM or spare hardware
2. Verify GRUB menu shows "Autoinstall Ubuntu Server"
3. Verify autoinstall starts automatically (no user prompts)
4. Monitor for any configuration errors
5. Confirm installation completes and reboots

See [7.2 Autoinstall Testing](../TESTING_AND_VALIDATION/AUTOINSTALL_TESTING.md) for complete testing workflow.

## Common Issues

| Issue | Symptom | Solution |
|-------|---------|----------|
| Missing datasource parameter | Drops to shell, no autoinstall | Add `ds=nocloud\;s=/cdrom/nocloud/` to kernel cmdline |
| Corrupted ISO | I/O errors during boot | Use in-place modification, not extract/rebuild |
| Screen blanking | Installer appears stuck | Add `consoleblank=0` to kernel cmdline |
